<!-- static/index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Azure Speech AI Chat</title>
  <!-- Azure Cognitive Services Speech SDK JS (CDN) -->
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 50px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
    .message { margin: 10px 0; }
    .user { color: blue; }
    .ai { color: green; }
    button { padding: 10px 20px; margin: 5px; }
    #status { margin-top: 10px; }
    #result { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Azure Speech AIチャットアプリ</h1>
  <div id="chat"></div>
  <button id="startBtn">音声認識開始</button>
  <button id="stopBtn" disabled>音声認識停止</button>
  <button id="resetBtn">リセット</button> <!-- リセットボタンの追加 -->
  <p id="status"></p>
  <p id="result"></p>

  <script>
    let audioConfig, speechRecognizer;
    let accumulatedText = ''; // 認識結果を蓄積する変数
    let conversationHistory = []; // 会話履歴を保持する配列

    document.getElementById("startBtn").onclick = async function() {
      document.getElementById("status").innerText = "トークン取得中...";
      accumulatedText = ''; // 認識開始前に蓄積テキストをリセット

      try {
        // サーバー(Flask)からトークンとリージョンをGET
        let resp = await fetch("/token");
        let data = await resp.json();
        if (data.error) {
          throw new Error(data.error);
        }
        let token = data.token;
        let region = data.region;

        // JavaScript SDKのSpeechConfigをToken連携モードで作成
        let speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
        speechConfig.speechRecognitionLanguage = "ja-JP"; // 必要に応じて

        // タイムアウト設定の変更
        // EndSilenceTimeoutMs を30秒に設定（デフォルトは5000ms）
        speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs, "30000");

        // 初期無音タイムアウトも延長（必要に応じて）
        speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs, "10000");

        // マイクアクセス(ユーザーが「許可」する必要あり)
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // AudioConfig.fromDefaultMicrophoneではなく、SDKのマイク取得機能に任せる方法もあるが、
        // 一部環境では getUserMedia() でストリームを確保→ createAudioConfig() するやり方が安定。
        audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();

        // SpeechRecognizerを作成
        speechRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
        document.getElementById("status").innerText = "音声認識を開始します...";

        // 認識開始イベント
        speechRecognizer.sessionStarted = (s, e) => {
          console.log("sessionStarted");
          document.getElementById("status").innerText = "録音中...(話してください)";
        };

        // 認識途中のイベント (部分的な結果)
        speechRecognizer.recognizing = (s, e) => {
          console.log("Recognizing:", e.result.text);
          document.getElementById("result").innerText = "途中結果: " + e.result.text;
          // 部分結果は蓄積しない
        };

        // 認識確定イベント (最終結果)
        speechRecognizer.recognized = (s, e) => {
          console.log("Recognized:", e.result);
          if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
            document.getElementById("result").innerText = "最終結果: " + e.result.text;
            // addMessage(e.result.text, 'user'); // ユーザーのメッセージをチャットに追加
            // sendMessageToAI(e.result.text); // AIにメッセージを送信
            accumulatedText += e.result.text + ' '; // テキストを蓄積
          } else {
            document.getElementById("result").innerText = "認識できませんでした";
          }
        };

        // セッション終了(マイク停止など)
        speechRecognizer.sessionStopped = (s, e) => {
          console.log("sessionStopped");
          document.getElementById("status").innerText = "認識セッションが終了しました。";
          document.getElementById("stopBtn").disabled = true;
          document.getElementById("startBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          
          if (accumulatedText.trim() !== '') {
            addMessage(accumulatedText.trim(), 'user'); // ユーザーのメッセージをチャットに追加
            sendMessageToAI(); // AIにメッセージを送信
          }
          accumulatedText = ''; // 蓄積テキストをリセット
        };

        // エラーイベント
        speechRecognizer.canceled = (s, e) => {
          console.warn("canceled", e);
          document.getElementById("status").innerText = "キャンセルまたはエラー";
          document.getElementById("stopBtn").disabled = true;
          document.getElementById("startBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          accumulatedText = ''; // 蓄積テキストをリセット
        };

        // 実際に認識開始
        speechRecognizer.startContinuousRecognitionAsync();
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        document.getElementById("resetBtn").disabled = true; // リセットボタンを無効化
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "エラー: " + err.message;
      }
    };

    document.getElementById("stopBtn").onclick = function() {
      if (speechRecognizer) {
        speechRecognizer.stopContinuousRecognitionAsync(
          () => {
            console.log("stop success");
            document.getElementById("status").innerText = "認識停止";
            document.getElementById("stopBtn").disabled = true;
            document.getElementById("startBtn").disabled = false;
            document.getElementById("resetBtn").disabled = false;
          },
          (err) => {
            console.error("stop error", err);
            document.getElementById("status").innerText = "停止中にエラーが発生";
          }
        );
      }
    };

    // リセットボタンの実装
    document.getElementById("resetBtn").onclick = function() {
      conversationHistory = []; // 会話履歴をリセット
      document.getElementById("chat").innerHTML = ''; // チャット表示をクリア
      document.getElementById("result").innerText = ''; // 認識結果表示をクリア
      document.getElementById("status").innerText = '会話がリセットされました。';
      document.getElementById("resetBtn").disabled = true; // リセットボタンを無効化
    };

    function addMessage(message, sender) {
      const chatDiv = document.getElementById('chat');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI'}:</strong> ${message}`;
      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;

      // 会話履歴に追加
      if (sender === 'user') {
        conversationHistory.push({ role: 'user', content: message });
      } else if (sender === 'ai') {
        conversationHistory.push({ role: 'assistant', content: message });
      }
    }

    async function sendMessageToAI() {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          // body: JSON.stringify({ message: message })
          body: JSON.stringify({ conversation: conversationHistory }) // 会話履歴を送信
        });

        const data = await response.json();
        if (data.error) {
          addMessage(data.error, 'ai');
        } else {
          addMessage(data.ai, 'ai');
        }
      } catch (err) {
        console.error(err);
        addMessage('サーバーとの通信中にエラーが発生しました。', 'ai');
      }
    }
  </script>
</body>
</html>
